<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meta CDUT - 3D查看器</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="./three.js"></script>
    <script src="./OrbitControls.js"></script>
    <script src="./GLTFLoader.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        dark: '#0F172A',
                        light: '#F8FAFC',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }
            .control-btn {
                @apply p-3 rounded-full transition transition-all duration-300 hover:bg-primary/20 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .axis-btn {
                @apply w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 hover:bg-primary/20 active:scale-95 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .panel {
                @apply bg-dark/70 backdrop-blur border border-white/10 rounded-xl transition transition-all duration-300;
            }
            .mobile-control {
                @apply fixed w-14 h-14 rounded-full bg-dark/60 backdrop-blur flex items-center justify-center shadow-lg transition-all duration-200 active:scale-90;
            }
            input[type="range"] {
                @apply appearance-none w-full h-2 bg-white/20 rounded-full outline-none;
            }
                input[type="range"]::-webkit-slider-thumb {
                    @apply appearance-none w-4 h-4 bg-primary rounded-full cursor-pointer;
                }
                input[type="range"]::-moz-range-thumb {
                    @apply w-4 h-4 bg-primary rounded-full cursor-pointer border-none;
                }
            .slider-value {
                @apply text-xs text-light/60 mt-1 flex justify-between;
            }
            .touch-hint {
                @apply fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-dark/70 backdrop-blur px-4 py-2 rounded-full text-sm z-30 hidden md:block;
            }
            .building-list-item {
                @apply p-2 rounded-lg hover:bg-primary/20 cursor-pointer transition-all duration-200 text-sm;
            }
                .building-list-item.active {
                    @apply bg-primary/30;
                }
            .search-container {
                @apply relative w-full mb-4;
            }
            .search-results {
                @apply relative w-full max-h-60 overflow-y-auto;
            }
            .search-result-item {
                @apply p-2 hover:bg-primary/20 cursor-pointer transition-all text-sm;
            }
            @media (max-width: 768px) {
                #propertiesPanel, #buildingsPanel {
                    width: 240px !important;
                    padding: 0.75rem !important;
                }
                    #propertiesPanel h3, #buildingsPanel h3 {
                        font-size: 1rem !important;
                        margin-bottom: 0.75rem !important;
                    }
                    #propertiesPanel .space-y-4 > div {
                        margin-bottom: 0.75rem !important;
                    }
                    #propertiesPanel label {
                        font-size: 0.75rem !important;
                    }
                #modalContent {
                    max-width: 280px !important;
                    padding: 1rem !important;
                }
                    #modalContent h2 {
                        font-size: 1.25rem !important;
                    }
                    #modalContent p, #modalContent li {
                        font-size: 0.85rem !important;
                    }
                #mobileResetView {
                    bottom: 60px !important;
                    left: 16px !important;
                }
                #mobileOrbitToggle {
                    bottom: 16px !important;
                    left: 16px !important;
                }
                #mobileWireframeToggle {
                    top: 80px !important;
                    right: 16px !important;
                }
            }
        }
    </style>
</head>
<body class="bg-dark text-light font-inter overflow-hidden h-screen">
    <header class="fixed top-0 left-0 right-0 z-50 bg-dark/70 backdrop-blur transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center w-full md:w-auto mb-3 md:mb-0">
                <h1 class="text-[clamp(1.2rem,3vw,1.8rem)] font-bold text-primary text-shadow">Meta CDUT</h1>
                <span class="text-xs text-light/60 ml-1">Developed by unq</span>
            </div>
            <div class="flex items-center space-x-4 w-full md:w-auto justify-end">
                <button id="infoBtn" class="p-2 rounded-full hover:bg-primary/20 transition-all">
                    <i class="fa fa-info text-light"></i>
                </button>
                <button id="fullscreenBtn" class="p-2 rounded-full hover:bg-primary/20 transition-all">
                    <i class="fa fa-expand text-light"></i>
                </button>
                <button id="toggleBuildingsBtn" class="p-2 rounded-full hover:bg-primary/20 transition-all">
                    <i class="fa fa-list text-light"></i>
                </button>
                <button id="togglePropertiesBtn" class="p-2 rounded-full hover:bg-primary/20 transition-all">
                    <i class="fa fa-sliders text-light"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="relative h-full w-full">
        <canvas id="viewerCanvas" class="w-full h-full"></canvas>
        <div id="initialLoading" class="absolute inset-0 flex items-center justify-center bg-dark/80 z-50">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p id="loadingStatus" class="mt-4 text-lg">初始化3D环境中...</p>
            </div>
        </div>
        <div id="resourceError" class="absolute inset-0 flex items-center justify-center bg-dark/80 z-50 hidden">
            <div class="text-center p-6 panel max-w-md">
                <i class="fa fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
                <h2 class="text-xl font-bold text-red-400 mb-2">Three.js资源加载失败</h2>
                <p class="text-light/80 mb-6">无法加载必要的3D渲染渲染库，请检查文件是否存在于同一目录</p>
                <button id="retryLoadResources" class="px-6 py-3 bg-primary hover:bg-primary/80 rounded-lg transition transition-all">
                    重新加载
                </button>
            </div>
        </div>
        <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-dark/80 z-40 transition-opacity duration-500 hidden">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-lg">加载3D模型中...</p>
                <div id="loadingProgress" class="mt-2 w-48 h-1 bg-white/20 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-primary w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>
        <div class="fixed:hidden">
            <button id="mobileResetView" class="mobile-control bottom-6 left-6" title="重置视图">
                <i class="fa fa-home text-light text-xl"></i>
            </button>
            <button id="mobileOrbitToggle" class="mobile-control bottom-6 right-6" title="切换自动旋转">
                <i class="fa fa-refresh text-light text-xl"></i>
            </button>
            <button id="mobileWireframeToggle" class="mobile-control top-24 right-6" title="切换线框模式">
                <i class="fa fa-cubes text-light text-xl"></i>
            </button>
        </div>
        <div class="touch-hint">
            <span>单指拖动旋转 | 双指拖动平移 | 双指捏合缩放</span>
        </div>
    </main>
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 panel px-4 py-2 flex items items-center space-x-6 z-40 opacity-50 pointer-events-events-none transition-all duration-300 hidden md:flex" id="controlPanel">
        <button id="cameraOrbitToggle" class="control-btn" title="切换自动旋转">
            <i class="fa fa-refresh text-light"></i>
        </button>
        <button id="resetView" class="control-btn" title="重置视图">
            <i class="fa fa-home text-light"></i>
        </button>
        <button id="zoomIn" class="control-btn" title="放大">
            <i class="fa fa-search-plus text-light"></i>
        </button>
        <button id="zoomOut" class="control-btn" title="缩小">
            <i class="fa fa-search-minus text-light"></i>
        </button>
        <button id="wireframeToggle" class="control-btn" title="切换线框模式">
            <i class="fa fa-cubes text-light"></i>
        </button>
    </div>
    <div id="propertiesPanel" class="fixed top-[53%] right-4 transform -translate-y-1/2 panel p-4 w-64 hidden md-hidden md:block opacity-100 pointer-events-events-auto transition-all duration-300 z-40">
        <h3 class="font-bold text-primary mb-4 flex items-center">
            <i class="fa fa-sliders mr-2"></i>属性控制
        </h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm mb-1 text-light/80">旋转灵敏度</label>
                <input id="rotationSensitivity" type="range" min="0.001" max="0.01" step="0.0005" value="0.005"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="rotationSensitivityValue">0.005</span></span>
                    <span>范围: 0.001-0.01</span>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1 text-light/80">拖拽平移灵敏度</label>
                <input id="panSensitivity" type="range" min="0.05" max="1.5" step="0.01" value="0.1"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="panSensitivityValue">0.1</span></span>
                    <span>范围: 0.05-1.5</span>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1 text-light/80">旋转速度</label>
                <input id="orbitSpeed" type="range" min="0.001" max="0.02" step="0.001" value="0.01"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="orbitSpeedValue">0.01</span></span>
                    <span>范围: 0.001-0.02</span>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1 text-light/80">移动速度</label>
                <input id="movementSpeed" type="range" min="0.1" max="5" step="0.1" value="1"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="movementSpeedValue">1</span></span>
                    <span>范围: 0.1-5</span>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1 text-light/80">环境光强度</label>
                <input id="ambientLight" type="range" min="0" max="5" step="0.1" value="1.2"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="ambientLightValue">1.2</span></span>
                    <span>范围: 0-5</span>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1 text-light/80">方向光强度</label>
                <input id="directionalLight" type="range" min="0" max="5" step="0.1" value="1.5"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="directionalLightValue">1.5</span></span>
                    <span>范围: 0-5</span>
                </div>
            </div>
            <div>
                <label class="block text-sm mb-1 text-light/80">背景亮度</label>
                <input id="backgroundBrightness" type="range" min="0" max="1" step="0.05" value="0.4"
                       class="w-full accent-primary">
                <div class="slider-value">
                    <span>值: <span id="backgroundBrightnessValue">0.4</span></span>
                    <span>范围: 0-1</span>
                </div>
            </div>
        </div>
    </div>
    <div id="buildingsPanel" class="fixed top-[53%] right-4 transform -translate-y-1/2 panel p-4 w-64 hidden opacity-0 pointer-events-none transition-all duration-300 z-40">
        <h3 class="font-bold text-primary mb-4 flex items-center">
            <i class="fa fa-cubes mr-2"></i>模型列表
        </h3>
        <div class="search-container">
            <input type="text" id="buildingSearch" placeholder="搜索模型..."
                   class="w-full bg-dark/50 border border-white/20 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
        </div>
        <div id="buildingsList" class="search-results">
            <div class="text-light/60 text-sm text-center py-4">加载模型中...</div>
        </div>
    </div>
    <div id="infoModal" class="fixed inset-0 bg-black/60 backdrop-blur z-50 flex items-center justify-center hidden">
        <div class="panel p-6 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">操作说明</h2>
                <button id="closeInfoBtn" class="text-light hover:text-primary transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <p class="text-light/80">此查看器用于展示成都理工大学三维重建模型</p>
                <div class="pt-2 border-t border-light/10">
                    <h3 class="font-semibold mb-2">桌面端控制方式：</h3>
                    <ul class="space-y-1 text-light/80">
                        <li><i class="fa fa-hand-paper-o mr-2 text-primary"></i> 滚轮键拖拽 - 平移相机</li>
                        <li><i class="fa fa-hand-pointer-o mr-2 text-primary"></i> 左键拖拽 - 旋转视角</li>
                        <li><i class="fa fa-search mr-2 text-primary"></i> 滚轮 - 缩放相机</li>
                        <li><i class="fa fa-hand-pointer-o mr-2 text-primary"></i> 双击 - 设置旋转中心</li>
                        <li><i class="fa fa-keyboard-o mr-2 text-primary"></i> WASD - 平移相机</li>
                        <li><i class="fa fa-keyboard-o mr-2 text-primary"></i> 上下键 - 摄像机上下移动</li>
                    </ul>
                </div>
                <div class="pt-2 border-t border-light/10">
                    <h3 class="font-semibold mb-2">移动端控制方式：</h3>
                    <ul class="space-y-1 text-light/80">
                        <li><i class="fa fa-hand-pointer-o mr-2 text-primary"></i> 单指拖拽 - 旋转视角</li>
                        <li><i class="fa fa-hand-rock-o mr-2 text-primary"></i> 双指拖拽 - 平移相机</li>
                        <li><i class="fa fa-arrows-alt mr-2 text-primary"></i> 双指捏合/张开 - 缩放</li>
                        <li><i class="fa fa-hand-pointer-o mr-2 text-primary"></i> 双击 - 设置旋转中心</li>
                    </ul>
                </div>
                <div class="pt-2 border-t border-light/10">
                    <h3 class="font-semibold mb-2">通用控制：</h3>
                    <ul class="space-y-1 text-light/80">
                        <li><i class="fa fa-refresh mr-2 text-primary"></i> 切换自动旋转</li>
                        <li><i class="fa fa-home mr-2 text-primary"></i> 重置视图</li>
                        <li><i class="fa fa-cubes mr-2 text-primary"></i> 切换线框模式</li>
                        <li><i class="fa fa-list mr-2 text-primary"></i> 模型列表 - 快速定位到特定模型</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script>
        let scene, camera, renderer, controls, model;
        let ambientLight, directionalLight, cameraLight;
        let cameraTarget = new THREE.Vector3(0, 0, 0);
        let isOrbiting = false;
        let rotationSpeed = 0.01;
        let movementSpeed = 1;
        let isWireframe = false;
        let cameraDistance = 100;
        let rotationX = 0;
        let rotationZ = 0;
        let isLeftDragging = false;
        let isMiddleDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let models = [];
        let activeModelId = -1;
        let rotationSensitivity = 0.005;
        let panSensitivity = 0.1;
        let touchStart = {
            touches: 0,
            distance: 0,
            center: { x: 0, y: 0 },
            rotation: { x: 0, z: 0 },
            distance: 0
        };
        const keys = {
            w: false, a: false, s: false, d: false,
            ArrowUp: false, ArrowDown: false
        };
        const canvas = document.getElementById('viewerCanvas');
        const initialLoading = document.getElementById('initialLoading');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const progressBar = document.getElementById('progressBar');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const controlPanel = document.getElementById('controlPanel');
        const propertiesPanel = document.getElementById('propertiesPanel');
        const modelsPanel = document.getElementById('buildingsPanel');
        const modelsList = document.getElementById('buildingsList');
        const modelSearch = document.getElementById('buildingSearch');
        function checkThreeJsLoaded() {
            if (typeof THREE === 'undefined') {
                document.getElementById('initialLoading').classList.add('hidden');
                document.getElementById('resourceError').classList.remove('hidden');
                return false;
            }
            return true;
        }
        function initApplication() {
            console.log('初始化应用程序');
            if (!checkThreeJsLoaded()) return;
            setTimeout(() => {
                document.getElementById('initialLoading').classList.add('hidden');
                loadModel('https://pub-c10bffdb38f848acb95ca9b5510a80f3.r2.dev/model.glb');
                showPropertiesPanel();
            }, 500);
            initScene();
            setupSearchFunctionality();
            document.getElementById('togglePropertiesBtn').addEventListener('click', () => {
                togglePropertiesPanel();
                if (modelsPanel.classList.contains('opacity-100')) {
                    hideModelsPanel();
                }
            });
            document.getElementById('toggleBuildingsBtn').addEventListener('click', () => {
                toggleModelsPanel();
                if (propertiesPanel.classList.contains('opacity-100')) {
                    hidePropertiesPanel();
                }
            });
            if (window.innerWidth < 768) {
                hidePropertiesPanel();
                hideModelsPanel();
                const mobileSliderButton = document.getElementById('togglePropertiesBtn');
                if (mobileSliderButton) {
                    mobileSliderButton.style.display = 'flex';
                }
                const mobileModelsButton = document.getElementById('toggleBuildingsBtn');
                if (mobileModelsButton) {
                    mobileModelsButton.style.display = 'flex';
                }
            }
        }
        function showPropertiesPanel() {
            propertiesPanel.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            propertiesPanel.classList.add('opacity-100', 'pointer-events-auto');
        }
        function hidePropertiesPanel() {
            propertiesPanel.classList.add('opacity-0', 'pointer-events-none');
            propertiesPanel.classList.remove('opacity-100', 'pointer-events-auto');
        }
        function togglePropertiesPanel() {
            if (propertiesPanel.classList.contains('opacity-100')) {
                hidePropertiesPanel();
            } else {
                showPropertiesPanel();
            }
        }
        function showModelsPanel() {
            modelsPanel.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            modelsPanel.classList.add('opacity-100', 'pointer-events-auto');
        }
        function hideModelsPanel() {
            modelsPanel.classList.add('opacity-0', 'pointer-events-none');
            modelsPanel.classList.remove('opacity-100', 'pointer-events-auto');
        }
        function toggleModelsPanel() {
            if (modelsPanel.classList.contains('opacity-100')) {
                hideModelsPanel();
            } else {
                showModelsPanel();
            }
        }
        function setupSearchFunctionality() {
            modelSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                filterModels(searchTerm);
            });
            filterModels('');
        }
        function filterModels(searchTerm) {
            modelsList.innerHTML = '';
            if (models.length === 0) {
                const noModelMsg = document.createElement('div');
                noModelMsg.className = 'text-light/60 text-sm text-center py-4';
                noModelMsg.textContent = '未识别到模型';
                modelsList.appendChild(noModelMsg);
                return;
            }
            let filteredModels = models;
            if (searchTerm.length > 0) {
                filteredModels = models.filter(model =>
                    model.name.toLowerCase().includes(searchTerm)
                );
            }
            if (filteredModels.length > 0) {
                filteredModels.sort((a, b) => a.name.localeCompare(b.name));
                filteredModels.forEach(model => {
                    const listItem = document.createElement('div');
                    listItem.className = `building-list-item ${activeModelId === model.id ? 'active' : ''}`;
                    listItem.textContent = model.name;
                    listItem.dataset.modelId = model.id;
                    listItem.addEventListener('click', () => {
                        moveToModel(model.id);
                    });
                    modelsList.appendChild(listItem);
                });
            } else {
                const noResult = document.createElement('div');
                noResult.className = 'text-light/60 text-sm text-center py-4';
                noResult.textContent = '未找到匹配的模型';
                modelsList.appendChild(noResult);
            }
        }
        function initScene() {
            console.log('初始化3D场景');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x3D4758);
            ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(ambientLight);
            directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(10, 20, 15);
            scene.add(directionalLight);
            cameraLight = new THREE.PointLight(0xffffff, 1.0, 1000);
            scene.add(cameraLight);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
            renderer = new THREE.WebGLRenderer({
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.5;
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enabled = false;
            updateCameraPosition();
            canvas.style.position = 'relative';
            canvas.style.zIndex = '10';
            setupEventListeners();
            animate();
        }
        function getDistance(touch1, touch2) {
            const dx = touch2.clientX - touch1.clientX;
            const dy = touch2.clientY - touch1.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        function getCenter(touch1, touch2) {
            return {
                x: (touch1.clientX + touch2.clientX) / 2,
                y: (touch1.clientY + touch2.clientY) / 2
            };
        }
        function setupEventListeners() {
            console.log('设置事件监听器');
            const canvasElement = document.getElementById('viewerCanvas');
            canvasElement.tabIndex = 1;
            canvasElement.style.touchAction = 'none';
            document.addEventListener('mousedown', (event) => {
                if (event.target === canvasElement) {
                    if (event.button === 0) {
                        console.log('左键按下 - 开始旋转');
                        isLeftDragging = true;
                        previousMousePosition = {
                            x: event.clientX,
                            y: event.clientY
                        };
                    }
                    else if (event.button === 1) {
                        console.log('中键按下 - 开始平移');
                        isMiddleDragging = true;
                        previousMousePosition = {
                            x: event.clientX,
                            y: event.clientY
                        };
                    }
                    canvasElement.focus();
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
            document.addEventListener('mousemove', (event) => {
                if (!isLeftDragging && !isMiddleDragging) return;
                const deltaX = event.clientX - previousMousePosition.x;
                const deltaY = event.clientY - previousMousePosition.y;
                if (isLeftDragging) {
                    rotationZ -= deltaX * rotationSensitivity;
                    rotationX -= deltaY * rotationSensitivity;
                    rotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotationX));
                }
                if (isMiddleDragging) {
                    const moveX = deltaX * panSensitivity * 0.1;
                    const moveY = deltaY * panSensitivity * 0.1;
                    cameraTarget.x += moveX;
                    cameraTarget.y -= moveY;
                }
                previousMousePosition = {
                    x: event.clientX,
                    y: event.clientY
                };
                event.preventDefault();
                event.stopPropagation();
            });
            document.addEventListener('mouseup', (event) => {
                if (event.button === 0) {
                    isLeftDragging = false;
                }
                if (event.button === 1) {
                    isMiddleDragging = false;
                }
                event.preventDefault();
                event.stopPropagation();
            });
            canvasElement.addEventListener('wheel', (event) => {
                event.preventDefault();
                const delta = Math.max(-1, Math.min(1, event.deltaY));
                cameraDistance += delta * movementSpeed * 2;
                cameraDistance = Math.max(10, Math.min(500, cameraDistance));
                updateCameraPosition();
            }, { passive: false });
            canvasElement.addEventListener('dblclick', (event) => {
                const rect = canvasElement.getBoundingClientRect();
                const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(x, y), camera);
                const intersects = raycaster.intersectObjects(scene.children, true);
                if (intersects.length > 0) {
                    cameraTarget.copy(intersects[0].point);
                }
            });
            canvasElement.addEventListener('touchstart', (event) => {
                event.preventDefault();
                touchStart.touches = event.touches.length;
                if (event.touches.length === 1) {
                    touchStart.center = { x: event.touches[0].clientX, y: event.touches[0].clientY };
                    touchStart.rotation = { x: rotationX, z: rotationZ };
                    isLeftDragging = true;
                } else if (event.touches.length === 2) {
                    touchStart.center = getCenter(event.touches[0], event.touches[1]);
                    touchStart.distance = getDistance(event.touches[0], event.touches[1]);
                    isMiddleDragging = true;
                }
            });
            canvasElement.addEventListener('touchmove', (event) => {
                event.preventDefault();
                if (event.touches.length !== touchStart.touches) {
                    touchStart.touches = event.touches.length;
                    return;
                }
                if (event.touches.length === 1 && isLeftDragging) {
                    const deltaX = event.touches[0].clientX - touchStart.center.x;
                    const deltaY = event.touches[0].clientY - touchStart.center.y;
                    rotationZ -= deltaX * rotationSensitivity * 0.5;
                    rotationX -= deltaY * rotationSensitivity * 0.5;
                    rotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, rotationX));
                } else if (event.touches.length === 2 && isMiddleDragging) {
                    const currentCenter = getCenter(event.touches[0], event.touches[1]);
                    const currentDistance = getDistance(event.touches[0], event.touches[1]);
                    const moveX = (currentCenter.x - touchStart.center.x) * panSensitivity * 0.01;
                    const moveY = (currentCenter.y - touchStart.center.y) * panSensitivity * 0.01;
                    cameraTarget.x += moveX;
                    cameraTarget.y -= moveY;
                    const scale = currentDistance / touchStart.distance;
                    cameraDistance *= scale;
                    cameraDistance = Math.max(10, Math.min(500, cameraDistance));
                    touchStart.center = currentCenter;
                    touchStart.distance = currentDistance;
                }
            });
            canvasElement.addEventListener('touchend', (event) => {
                isLeftDragging = false;
                isMiddleDragging = false;
                touchStart.touches = 0;
            });
            window.addEventListener('keydown', (event) => {
                if (['w', 'a', 's', 'd', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
                    keys[event.key] = true;
                    event.preventDefault();
                }
            });
            window.addEventListener('keyup', (event) => {
                if (['w', 'a', 's', 'd', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
                    keys[event.key] = false;
                    event.preventDefault();
                }
            });
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            document.getElementById('cameraOrbitToggle').addEventListener('click', toggleOrbit);
            document.getElementById('resetView').addEventListener('click', resetView);
            document.getElementById('zoomIn').addEventListener('click', () => {
                cameraDistance = Math.max(10, cameraDistance - 10);
                updateCameraPosition();
            });
            document.getElementById('zoomOut').addEventListener('click', () => {
                cameraDistance = Math.min(500, cameraDistance + 10);
                updateCameraPosition();
            });
            document.getElementById('wireframeToggle').addEventListener('click', toggleWireframe);
            document.getElementById('infoBtn').addEventListener('click', () => {
                document.getElementById('infoModal').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('modalContent').classList.add('scale-100', 'opacity-100');
                }, 10);
            });
            document.getElementById('closeInfoBtn').addEventListener('click', () => {
                document.getElementById('modalContent').classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    document.getElementById('infoModal').classList.add('hidden');
                }, 300);
            });
            document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
            document.getElementById('retryLoadResources').addEventListener('click', () => {
                location.reload();
            });
            document.getElementById('mobileResetView').addEventListener('click', resetView);
            document.getElementById('mobileOrbitToggle').addEventListener('click', toggleOrbit);
            document.getElementById('mobileWireframeToggle').addEventListener('click', toggleWireframe);
            document.getElementById('rotationSensitivity').addEventListener('input', (e) => {
                rotationSensitivity = parseFloat(e.target.value);
                document.getElementById('rotationSensitivityValue').textContent = rotationSensitivity.toFixed(4);
            });
            document.getElementById('panSensitivity').addEventListener('input', (e) => {
                panSensitivity = parseFloat(e.target.value);
                document.getElementById('panSensitivityValue').textContent = panSensitivity.toFixed(2);
            });
            document.getElementById('orbitSpeed').addEventListener('input', (e) => {
                rotationSpeed = parseFloat(e.target.value);
                document.getElementById('orbitSpeedValue').textContent = rotationSpeed.toFixed(3);
            });
            document.getElementById('movementSpeed').addEventListener('input', (e) => {
                movementSpeed = parseFloat(e.target.value);
                document.getElementById('movementSpeedValue').textContent = movementSpeed.toFixed(1);
            });
            document.getElementById('ambientLight').addEventListener('input', (e) => {
                const intensity = parseFloat(e.target.value);
                ambientLight.intensity = intensity;
                document.getElementById('ambientLightValue').textContent = intensity.toFixed(1);
            });
            document.getElementById('directionalLight').addEventListener('input', (e) => {
                const intensity = parseFloat(e.target.value);
                directionalLight.intensity = intensity;
                document.getElementById('directionalLightValue').textContent = intensity.toFixed(1);
            });
            document.getElementById('backgroundBrightness').addEventListener('input', (e) => {
                const brightness = parseFloat(e.target.value);
                scene.background.setHSL(0.6, 0.2, brightness);
                document.getElementById('backgroundBrightnessValue').textContent = brightness.toFixed(2);
            });
        }
        function updateCameraPosition() {
            const x = cameraTarget.x + Math.sin(rotationZ) * cameraDistance;
            const y = cameraTarget.y + Math.sin(rotationX) * cameraDistance;
            const z = cameraTarget.z + Math.cos(rotationZ) * cameraDistance;
            camera.position.set(x, y, z);
            camera.lookAt(cameraTarget);
        }
        function animate() {
            requestAnimationFrame(animate);
            if (isOrbiting) {
                rotationZ -= rotationSpeed;
                if (rotationZ < -2 * Math.PI) rotationZ += 2 * Math.PI;
            }
            updateCameraPosition();
            renderer.render(scene, camera);
        }
        function toggleOrbit() {
            isOrbiting = !isOrbiting;
            document.getElementById('cameraOrbitToggle').classList.toggle('text-primary');
            document.getElementById('mobileOrbitToggle').classList.toggle('text-primary');
        }
        function resetView() {
            rotationX = 0;
            rotationZ = 0;
            cameraDistance = 100;
            cameraTarget.set(0, 0, 0);
            isOrbiting = false;
            document.getElementById('cameraOrbitToggle').classList.remove('text-primary');
            document.getElementById('mobileOrbitToggle').classList.remove('text-primary');
            updateCameraPosition();
        }
        function toggleWireframe() {
            isWireframe = !isWireframe;
            if (model) {
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.wireframe = isWireframe;
                    }
                });
            }
            document.getElementById('wireframeToggle').classList.toggle('text-primary');
            document.getElementById('mobileWireframeToggle').classList.toggle('text-primary');
        }
        function loadModel(url) {
            loadingIndicator.classList.remove('hidden');
            const loader = new THREE.GLTFLoader();
            loader.load(
                url,
                (gltf) => {
                    model = gltf.scene;
                    scene.add(model);
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    cameraTarget.copy(center);
                    cameraDistance = maxDim * 2;
                    updateCameraPosition();
                    loadingIndicator.classList.add('hidden');
                    extractModelsFromScene();
                },
                (xhr) => {
                    const progress = (xhr.loaded / xhr.total) * 100;
                    progressBar.style.width = `${progress}%`;
                },
                (error) => {
                    console.error('模型加载错误:', error);
                    loadingIndicator.classList.add('hidden');
                    alert('模型加载失败，请检查模型文件是否存在或格式是否正确');
                }
            );
        }
        function extractModelsFromScene() {
            models = [];
            let modelCounter = 0;
            scene.traverse((object) => {
                if (object.isMesh) {
                    models.push({
                        id: modelCounter++,
                        name: object.name || `模型_${modelCounter}`,
                        object: object
                    });
                }
            });
            filterModels('');
        }
        function moveToModel(modelId) {
            const model = models.find(m => m.id === modelId);
            if (model) {
                activeModelId = modelId;
                cameraTarget.copy(model.object.position);
                cameraDistance = 50;
                isOrbiting = false;
                document.getElementById('cameraOrbitToggle').classList.remove('text-primary');
                document.getElementById('mobileOrbitToggle').classList.remove('text-primary');
                updateCameraPosition();
                filterModels(modelSearch.value);
            }
        }
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`进入全屏失败: ${err.message}`);
                });
                document.getElementById('fullscreenBtn').innerHTML = '<i class="fa fa-compress text-light"></i>';
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
                document.getElementById('fullscreenBtn').innerHTML = '<i class="fa fa-expand text-light"></i>';
            }
        }
        window.addEventListener('load', initApplication);
    </script>
</body>
</html>

